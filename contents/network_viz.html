<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negativity Wave Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        #controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        select, button {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:hover, button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        #viz-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        #timeline-container {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        #timeline {
            width: 100%;
            height: 40px;
            cursor: pointer;
        }

        #stats-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 250px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .stat-label {
            opacity: 0.7;
        }

        .stat-value {
            font-weight: bold;
            margin-left: 15px;
        }

        .stat-value.source { color: #ff4444; }
        .stat-value.neighbor { color: #ffaa44; }
        .stat-value.other { color: #888; }

        .node {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node:hover {
            stroke-width: 3px;
        }

        .node.source {
            fill: #ff4444;
            stroke: #ff6666;
        }

        .node.neighbor {
            fill: #ffaa44;
            stroke: #ffcc66;
        }

        .node.other {
            fill: #666;
            stroke: #888;
        }

        .link {
            stroke-opacity: 0.6;
            transition: all 0.3s;
        }

        .link.negative {
            stroke: #ff4444;
        }

        .link.positive {
            stroke: #44ff44;
        }

        .link.mixed {
            stroke: #ffaa44;
        }

        .node-label {
            font-size: 11px;
            fill: #fff;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 0 3px #000, 0 0 5px #000;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .tooltip-row {
            margin: 3px 0;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 12px;
        }

        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>NEGATIVITY WAVE NETWORK</h1>
            <div id="controls">
                <div class="control-group">
                    <label>Peak:</label>
                    <select id="peak-select"></select>
                </div>
                <div class="control-group">
                    <label>Time Bin:</label>
                    <span id="time-bin-label">0</span>
                </div>
                <div class="control-group">
                    <button id="play-btn" class="play-btn">▶</button>
                    <button id="reset-btn">Reset</button>
                </div>
                <div class="control-group">
                    <label>Speed:</label>
                    <select id="speed-select">
                        <option value="3000">Slow</option>
                        <option value="2000" selected>Medium</option>
                        <option value="1000">Fast</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="viz-container">
            <svg id="network"></svg>
            
            <div id="stats-panel">
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">METRICS</div>
                <div class="stat-row">
                    <span class="stat-label">Time Bin:</span>
                    <span class="stat-value" id="stat-bin">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sources:</span>
                    <span class="stat-value source" id="stat-sources">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Neighbors:</span>
                    <span class="stat-value neighbor" id="stat-neighbors">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Others:</span>
                    <span class="stat-value other" id="stat-others">-</span>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid rgba(255,255,255,0.2);">
                <div class="stat-row">
                    <span class="stat-label">Total Links:</span>
                    <span class="stat-value" id="stat-links">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Negative Links:</span>
                    <span class="stat-value" id="stat-neg-links">-</span>
                </div>
            </div>

            <div id="legend">
                <div style="font-weight: bold; margin-bottom: 8px;">NODE TYPES</div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #ff4444;"></div>
                    <span>Original Sources</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #ffaa44;"></div>
                    <span>Neighbors (Tagged In)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #666;"></div>
                    <span>Others</span>
                </div>
            </div>
        </div>

        <div id="timeline-container">
            <svg id="timeline"></svg>
        </div>
    </div>

    <div id="tooltip"></div>

    <script>
        // ========================================
        // GLOBAL STATE
        // ========================================
        let vizData = null;
        let currentPeakIndex = 0;
        let currentBinIndex = 0;
        let isPlaying = false;
        let playInterval = null;
        let simulation = null;

        // D3 elements
        let svg, g, link, node, nodeLabel, tooltip;
        let timelineSvg, timelineScale, brush;

        // ========================================
        // LOAD SAMPLE DATA (REPLACE WITH YOUR JSON)
        // ========================================
        const sampleData = {
            "peaks": [
                {
                    "peak_id": 1,
                    "time_bins": [
                        {
                            "time_bin": 0,
                            "nodes": [
                                {"id": "r/politics", "type": "source", "neg_ratio": 0.85, "total_interactions": 120, "neg_interactions": 102},
                                {"id": "r/news", "type": "neighbor", "neg_ratio": 0.32, "total_interactions": 85, "neg_interactions": 27},
                                {"id": "r/worldnews", "type": "neighbor", "neg_ratio": 0.28, "total_interactions": 65, "neg_interactions": 18},
                                {"id": "OTHERS_AGGREGATE", "type": "other", "neg_ratio": 0.15, "total_interactions": 300, "neg_interactions": 45}
                            ],
                            "links": [
                                {"source": "r/politics", "target": "r/news", "neg_count": 25, "total_count": 30, "neg_ratio": 0.83},
                                {"source": "r/politics", "target": "r/worldnews", "neg_count": 15, "total_count": 20, "neg_ratio": 0.75},
                                {"source": "r/politics", "target": "OTHERS_AGGREGATE", "neg_count": 10, "total_count": 40, "neg_ratio": 0.25}
                            ]
                        },
                        {
                            "time_bin": 1,
                            "nodes": [
                                {"id": "r/politics", "type": "source", "neg_ratio": 0.78, "total_interactions": 110, "neg_interactions": 86},
                                {"id": "r/news", "type": "neighbor", "neg_ratio": 0.48, "total_interactions": 95, "neg_interactions": 46},
                                {"id": "r/worldnews", "type": "neighbor", "neg_ratio": 0.35, "total_interactions": 70, "neg_interactions": 25},
                                {"id": "OTHERS_AGGREGATE", "type": "other", "neg_ratio": 0.18, "total_interactions": 320, "neg_interactions": 58}
                            ],
                            "links": [
                                {"source": "r/politics", "target": "r/news", "neg_count": 22, "total_count": 28, "neg_ratio": 0.79},
                                {"source": "r/politics", "target": "r/worldnews", "neg_count": 18, "total_count": 25, "neg_ratio": 0.72},
                                {"source": "r/news", "target": "r/worldnews", "neg_count": 8, "total_count": 15, "neg_ratio": 0.53},
                                {"source": "r/politics", "target": "OTHERS_AGGREGATE", "neg_count": 12, "total_count": 45, "neg_ratio": 0.27}
                            ]
                        },
                        {
                            "time_bin": 2,
                            "nodes": [
                                {"id": "r/politics", "type": "source", "neg_ratio": 0.65, "total_interactions": 95, "neg_interactions": 62},
                                {"id": "r/news", "type": "neighbor", "neg_ratio": 0.52, "total_interactions": 105, "neg_interactions": 55},
                                {"id": "r/worldnews", "type": "neighbor", "neg_ratio": 0.42, "total_interactions": 75, "neg_interactions": 32},
                                {"id": "OTHERS_AGGREGATE", "type": "other", "neg_ratio": 0.22, "total_interactions": 340, "neg_interactions": 75}
                            ],
                            "links": [
                                {"source": "r/politics", "target": "r/news", "neg_count": 18, "total_count": 25, "neg_ratio": 0.72},
                                {"source": "r/politics", "target": "r/worldnews", "neg_count": 12, "total_count": 20, "neg_ratio": 0.60},
                                {"source": "r/news", "target": "r/worldnews", "neg_count": 12, "total_count": 20, "neg_ratio": 0.60},
                                {"source": "r/news", "target": "OTHERS_AGGREGATE", "neg_count": 8, "total_count": 25, "neg_ratio": 0.32},
                                {"source": "r/politics", "target": "OTHERS_AGGREGATE", "neg_count": 10, "total_count": 50, "neg_ratio": 0.20}
                            ]
                        }
                    ]
                }
            ],
            "metadata": {
                "bin_size_hours": 6.0,
                "aggregate_others": true
            }
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            // Use sample data (replace this line to load your JSON file)
            //vizData = sampleData;
            
            // Uncomment below to load from file:
            d3.json('network_viz_data_agg.json').then(data => {
                 vizData = data;
                 setupViz();
         });
            
            //setupViz();
        }

        function setupViz() {
            // Setup peak selector
            const peakSelect = d3.select('#peak-select');
            peakSelect.selectAll('option')
                .data(vizData.peaks)
                .enter()
                .append('option')
                .attr('value', (d, i) => i)
                .text(d => `Peak ${d.peak_id}`);

            peakSelect.on('change', function() {
                currentPeakIndex = +this.value;
                currentBinIndex = 0;
                updateVisualization();
            });

            // Setup SVG
            const container = d3.select('#viz-container');
            svg = d3.select('#network');
            const width = container.node().getBoundingClientRect().width;
            const height = container.node().getBoundingClientRect().height;

            svg.attr('width', width).attr('height', height);

            // Add zoom
            const zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g');

            // Create groups for links and nodes
            g.append('g').attr('class', 'links');
            g.append('g').attr('class', 'nodes');
            g.append('g').attr('class', 'labels');

            // Setup tooltip
            tooltip = d3.select('#tooltip');

            // Setup timeline
            setupTimeline();

            // Setup controls
            d3.select('#play-btn').on('click', togglePlay);
            d3.select('#reset-btn').on('click', reset);
            d3.select('#speed-select').on('change', function() {
                if (isPlaying) {
                    stopPlay();
                    startPlay();
                }
            });

            // Initial render
            updateVisualization();
        }

        // ========================================
        // UPDATE VISUALIZATION
        // ========================================
        function updateVisualization() {
            const peak = vizData.peaks[currentPeakIndex];
            const binData = peak.time_bins[currentBinIndex];

            // Update time bin label
            d3.select('#time-bin-label').text(binData.time_bin);
            d3.select('#stat-bin').text(binData.time_bin);

            // Update stats panel
            updateStats(binData);

            // Render network
            renderNetwork(binData);

            // Update timeline
            updateTimelineMarker();
        }

        function renderNetwork(binData) {
            const width = +svg.attr('width');
            const height = +svg.attr('height');

            // Prepare data
            const nodes = binData.nodes.map(d => ({...d}));
            const links = binData.links.map(d => ({...d}));

            // Stop any existing simulation
            if (simulation) simulation.stop();

            simulation = null;

            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => getNodeRadius(d) + 10))
                .alpha(0.9)
                .alphaDecay(0.1)
                .alphaMin(0.001);

            // Create force simulation
            //simulation = d3.forceSimulation(nodes)
            //    .force('link', d3.forceLink(links).id(d => d.id).distance(150))
            //    .force('charge', d3.forceManyBody().strength(-200))
            //    .force('center', d3.forceCenter(width / 2, height / 2))
            //    .force('collision', d3.forceCollide().radius(d => getNodeRadius(d) + 10));

            // Render links
            const linkSelection = g.select('.links')
                .selectAll('line')
                .data(links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);

            linkSelection.exit().remove();

            const linkEnter = linkSelection.enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.total_count) * 2)
                .on('mouseover', showLinkTooltip)
                .on('mouseout', hideTooltip);

            link = linkEnter.merge(linkSelection)
                .attr('class', d => {
                    if (d.neg_ratio > 0.6) return 'link negative';
                    if (d.neg_ratio < 0.4) return 'link positive';
                    return 'link mixed';
                });

            // Render nodes
            const nodeSelection = g.select('.nodes')
                .selectAll('circle')
                .data(nodes, d => d.id);

            nodeSelection.exit().remove();

            const nodeEnter = nodeSelection.enter()
                .append('circle')
                .attr('class', d => `node ${d.type}`)
                .attr('r', d => getNodeRadius(d))
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', showNodeTooltip)
                .on('mouseout', hideTooltip);

            node = nodeEnter.merge(nodeSelection)
                .attr('r', d => getNodeRadius(d));

            // Render labels
            const labelSelection = g.select('.labels')
                .selectAll('text')
                .data(nodes, d => d.id);

            labelSelection.exit().remove();

            const labelEnter = labelSelection.enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('dy', d => getNodeRadius(d) + 15);

            nodeLabel = labelEnter.merge(labelSelection)
                .text(d => d.id === 'OTHERS_AGGREGATE' ? 'Others' : d.id);

            // Simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                nodeLabel
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function getNodeRadius(node) {
            // Size by negativity ratio (larger = more negative)
            const baseRadius = 15;
            const maxRadius = 40;
            return baseRadius + (node.neg_ratio * (maxRadius - baseRadius));
        }

        // ========================================
        // STATS PANEL
        // ========================================
        function updateStats(binData) {
            const sourceNodes = binData.nodes.filter(d => d.type === 'source');
            const neighborNodes = binData.nodes.filter(d => d.type === 'neighbor');
            const otherNodes = binData.nodes.filter(d => d.type === 'other');

            const avgSourceRatio = d3.mean(sourceNodes, d => d.neg_ratio) || 0;
            const avgNeighborRatio = d3.mean(neighborNodes, d => d.neg_ratio) || 0;
            const avgOtherRatio = d3.mean(otherNodes, d => d.neg_ratio) || 0;

            d3.select('#stat-sources').text(`${(avgSourceRatio * 100).toFixed(1)}%`);
            d3.select('#stat-neighbors').text(`${(avgNeighborRatio * 100).toFixed(1)}%`);
            d3.select('#stat-others').text(`${(avgOtherRatio * 100).toFixed(1)}%`);

            const totalLinks = d3.sum(binData.links, d => d.total_count);
            const negLinks = d3.sum(binData.links, d => d.neg_count);

            d3.select('#stat-links').text(totalLinks);
            d3.select('#stat-neg-links').text(negLinks);
        }

        // ========================================
        // TOOLTIPS
        // ========================================
        function showNodeTooltip(event, d) {
            const html = `
                <div class="tooltip-title">${d.id}</div>
                <div class="tooltip-row">Type: <strong>${d.type}</strong></div>
                <div class="tooltip-row">Total Interactions: <strong>${d.total_interactions}</strong></div>
                <div class="tooltip-row">Negative: <strong>${d.neg_interactions}</strong></div>
                <div class="tooltip-row">Negativity Ratio: <strong>${(d.neg_ratio * 100).toFixed(1)}%</strong></div>
            `;
            
            tooltip
                .html(html)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .style('opacity', 1);
        }

        function showLinkTooltip(event, d) {
            const sourceId = d.source.id || d.source;
            const targetId = d.target.id || d.target;
            
            const html = `
                <div class="tooltip-title">${sourceId} → ${targetId}</div>
                <div class="tooltip-row">Total Links: <strong>${d.total_count}</strong></div>
                <div class="tooltip-row">Negative Links: <strong>${d.neg_count}</strong></div>
                <div class="tooltip-row">Negativity Ratio: <strong>${(d.neg_ratio * 100).toFixed(1)}%</strong></div>
            `;
            
            tooltip
                .html(html)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .style('opacity', 1);
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        // ========================================
        // DRAG HANDLERS
        // ========================================
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // ========================================
        // TIMELINE
        // ========================================
        function setupTimeline() {
            const container = d3.select('#timeline-container');
            timelineSvg = d3.select('#timeline');
            const width = container.node().getBoundingClientRect().width;
            const height = 40;

            timelineSvg.attr('width', width).attr('height', height);

            const peak = vizData.peaks[currentPeakIndex];
            const numBins = peak.time_bins.length;

            timelineScale = d3.scaleLinear()
                .domain([0, numBins - 1])
                .range([20, width - 20]);

            // Draw axis
            const axis = d3.axisBottom(timelineScale)
                .ticks(numBins)
                .tickFormat(d => d);

            timelineSvg.append('g')
                .attr('class', 'timeline-axis')
                .attr('transform', 'translate(0, 20)')
                .call(axis)
                .selectAll('text')
                .style('fill', '#fff');

            timelineSvg.selectAll('.timeline-axis path, .timeline-axis line')
                .style('stroke', '#fff');

            // Add marker
            timelineSvg.append('circle')
                .attr('class', 'timeline-marker')
                .attr('r', 6)
                .attr('fill', '#ff4444')
                .attr('cy', 20);

            // Click to jump
            timelineSvg.on('click', function(event) {
                const [x] = d3.pointer(event);
                const binIndex = Math.round(timelineScale.invert(x));
                if (binIndex >= 0 && binIndex < numBins) {
                    currentBinIndex = binIndex;
                    updateVisualization();
                }
            });
        }

        function updateTimelineMarker() {
            timelineSvg.select('.timeline-marker')
                .attr('cx', timelineScale(currentBinIndex));
        }

        // ========================================
        // PLAYBACK CONTROLS
        // ========================================
        function togglePlay() {
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }

        function startPlay() {
            isPlaying = true;
            d3.select('#play-btn').html('⏸');
            
            const speed = +d3.select('#speed-select').property('value');
            const peak = vizData.peaks[currentPeakIndex];
            
            playInterval = setInterval(() => {
                currentBinIndex++;
                if (currentBinIndex >= peak.time_bins.length) {
                    currentBinIndex = peak.time_bins.length - 1;
                    stopPlay();
                    return;
                }
                updateVisualization();
            }, speed);
        }

        function stopPlay() {
            isPlaying = false;
            d3.select('#play-btn').html('▶');
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function reset() {
            stopPlay();
            currentBinIndex = 0;
            updateVisualization();
        }

        // ========================================
        // START
        // ========================================
        init();
    </script>
</body>
</html>
